<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* --- üé® Pastel Theme Palette --- */
        :root {
            --bg-color: #f0fdf4;
            --primary-color: #57b894;
            --primary-hover: #429778;
            --text-dark: #334155;
            --text-muted: #64748b;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            
            --success-bg: #d1fae5; --success-text: #065f46;
            --warning-bg: #fef3c7; --warning-text: #92400e;
            --danger-bg: #fee2e2;  --danger-text: #b91c1c;
        }

        body { padding: 20px; background-color: var(--bg-color); font-family: 'Sarabun', sans-serif; color: var(--text-dark); }

        .main-header {
            background: white; padding: 15px 20px; border-radius: 16px;
            box-shadow: var(--card-shadow); margin-bottom: 20px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
        }
        h3 { font-weight: 700; color: var(--primary-color); margin: 0; font-size: 1.4rem; }

        .btn { border-radius: 8px; font-weight: 500; transition: all 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }

        .source-btn { border: 1px solid #e2e8f0; background: white; color: var(--text-muted); border-radius: 8px; padding: 8px 16px; font-weight: 600; font-size: 0.9rem; }
        .source-btn.active { border-color: var(--primary-color); background-color: #ecfdf5; color: var(--primary-color); box-shadow: 0 2px 4px rgba(87, 184, 148, 0.2); }

        #filterButtonContainer { display: flex; flex-wrap: wrap; gap: 6px; }
        .warehouse-btn { background: white; border: 1px solid #e2e8f0; color: var(--text-muted); border-radius: 6px; padding: 4px 10px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.02); display: inline-flex; align-items: center; }
        .warehouse-btn:hover { background-color: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
        .warehouse-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 2px 4px rgba(87, 184, 148, 0.25); font-weight: 600; }
        .count-badge { background-color: rgba(0,0,0,0.05); color: inherit; border-radius: 4px; padding: 0 5px; margin-left: 5px; font-size: 0.8em; }
        .active .count-badge { background-color: rgba(255,255,255,0.25); color: white; }

        .status-header { font-weight: 700; text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 1rem; }
        .bg-head-success { background-color: var(--success-bg); color: var(--success-text); }
        .bg-head-warning { background-color: var(--warning-bg); color: var(--warning-text); }
        .bg-head-danger  { background-color: var(--danger-bg);  color: var(--danger-text); }

        .po-card { background: white; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 12px; overflow: hidden; border-left: 5px solid #ccc; transition: transform 0.2s ease; }
        .po-card:hover { transform: translateY(-2px); }
        .card-border-success { border-left-color: #34d399 !important; }
        .card-border-warning { border-left-color: #fbbf24 !important; }
        .card-border-danger  { border-left-color: #f87171 !important; }

        .po-header { padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid #f1f5f9; font-weight: 600; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; }
        .po-body { padding: 12px 15px; font-size: 0.9rem; }
        .info-row { display: flex; margin-bottom: 6px; align-items: baseline; }
        .info-label { width: 85px; color: var(--text-muted); font-size: 0.8rem; }
        .info-value { flex: 1; font-weight: 500; color: var(--text-dark); }
        .status-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .bg-success { background-color: var(--success-bg) !important; color: var(--success-text) !important; }
        .bg-warning { background-color: var(--warning-bg) !important; color: var(--warning-text) !important; }
        .bg-danger  { background-color: var(--danger-bg) !important;  color: var(--danger-text) !important; }
        .vendor-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 6px; color: white; font-weight: 500; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a7f3d0, #57b894); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .login-input { font-size: 1.5rem; letter-spacing: 3px; text-align: center; border-radius: 12px; padding: 12px; margin-bottom: 20px; border: 2px solid #e2e8f0; background: #f8fafc; }
        .upload-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:10000; display:none; flex-direction:column; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .file-input { display: none; }
        .no-data-alert { text-align: center; padding: 40px; color: var(--text-muted); background: white; border-radius: 16px; margin-top: 20px; box-shadow: var(--card-shadow); border: 2px dashed #e2e8f0; }
        
        .load-more-btn { background: white; border: 1px solid #e2e8f0; color: var(--primary-color); padding: 8px 24px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
        .load-more-btn:hover { background: #f8fafc; transform: scale(1.02); }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-header { padding: 15px; flex-direction: column; align-items: stretch; text-align: center; gap: 10px; }
            .d-flex.gap-2 { justify-content: center; flex-wrap: wrap; }
            .source-btn { width: 100%; margin: 2px 0; justify-content: center; }
            .col-md-4 { margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div id="uploadLoader" class="upload-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h6 class="mt-3 text-dark fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</h6>
        <small class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</small>
    </div>

    <div id="loginOverlay">
        <div class="login-card">
            <div class="mb-4">
                <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex p-3 mb-3">
                    <i class="fas fa-cubes fa-2x text-success"></i>
                </div>
                <h3 class="text-dark fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <p class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PO</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="loginId" class="form-control login-input" placeholder="CODE" required autofocus>
                <button type="submit" id="btnLogin" class="btn btn-primary btn-lg w-100 fw-bold shadow-sm">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
            </form>
            <div id="loginMsg" class="mt-3 text-danger fw-bold small"></div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark ps-2"><i class="fas fa-cloud-upload-alt text-primary"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted small mb-4 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà)</p>
                    <div class="d-grid gap-3">
                        <input type="file" id="file_CHV" class="file-input" accept=".xlsx" onchange="processUpload('CHV_DATA', this)">
                        <button class="btn btn-outline-primary text-start p-3" onclick="document.getElementById('file_CHV').click()">
                            <i class="fas fa-file-excel me-2"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î <b>Chevron</b>
                        </button>
                        <input type="file" id="file_MRC" class="file-input" accept=".xlsx" onchange="processUpload('MRC_DATA', this)">
                        <button class="btn btn-outline-success text-start p-3" onclick="document.getElementById('file_MRC').click()">
                            <i class="fas fa-file-excel me-2"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î <b>Miracle</b>
                        </button>
                        <input type="file" id="file_PSP" class="file-input" accept=".xlsx" onchange="processUpload('EX-Godown_Data', this)">
                        <button class="btn btn-outline-warning text-dark text-start p-3" onclick="document.getElementById('file_PSP').click()">
                            <i class="fas fa-file-excel me-2"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î <b>PSP</b>
                        </button>
                         <input type="file" id="file_ME2N" class="file-input" accept=".xlsx" onchange="processUpload('Me2n', this)">
                         <button class="btn btn-outline-secondary text-start p-3" onclick="document.getElementById('file_ME2N').click()">
                            <i class="fas fa-file-excel me-2"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î <b>ME2N</b>
                         </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="container-fluid" style="max-width: 1400px; display: none;">
        <div class="main-header">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                    <i class="fas fa-search-location fa-lg"></i>
                </div>
                <div>
                    <h3 class="mb-0">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PO</h3>
                    <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</small>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark border"><i class="fas fa-user-circle text-muted"></i> <span id="userRoleDisplay">-</span></span>
                <span class="badge bg-white text-dark border" id="userWarehouseBadge" style="display:none;">
                    <i class="fas fa-warehouse text-primary"></i> <span id="userWarehouseDisplay"></span>
                </span>
                
                <button id="headerUploadBtn" class="btn btn-primary btn-sm shadow-sm" style="display:none;" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-cloud-upload-alt"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                </button>
                <button id="headerExportBtn" class="btn btn-success btn-sm shadow-sm text-white" onclick="exportToExcel()" style="background-color: #10b981; border:none;">
                    <i class="fas fa-file-download"></i> Export
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="card p-4 mb-4 border-0" style="border-radius: 16px; box-shadow: var(--card-shadow);">
             <div class="row g-4">
                <div class="col-md-5">
                    <label class="form-label text-muted fw-bold small text-uppercase ls-1">Supplier</label>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="source-btn active" onclick="toggleSource('CHV', this)">Chevron</button>
                        <button class="source-btn active" onclick="toggleSource('MRC', this)">Miracle</button>
                        <button class="source-btn active" onclick="toggleSource('EX-Godown', this)">PSP</button>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted" style="font-size: 0.8rem;">
                            <i class="far fa-clock me-1 text-primary"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: 
                            <span id="lastUpdateDisplay" class="fw-bold text-dark">-</span>
                        </small>
                    </div>

                </div>
                <div class="col-md-7">
                    <label class="form-label text-muted fw-bold small text-uppercase ls-1">Warehouse (‡∏Ñ‡∏•‡∏±‡∏á)</label>
                    <div id="filterButtonContainer">
                        <span class="text-muted fst-italic small">Loading...</span>
                    </div>
                </div>
            </div>
            <hr class="my-4" style="opacity: 0.1;">
            <div class="row g-2 align-items-center">
                <div class="col-md-9">
                    <div class="input-group shadow-sm" style="border-radius: 50px; overflow: hidden;">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-0 py-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç PO ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 py-2 shadow-sm rounded-pill" onclick="performSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="resultSection" style="display: none;">
            <div id="noDataMessage" style="display: none;"></div>
            <div id="cardContainer" class="row g-4">
                <div class="col-md-4">
                    <div class="status-header bg-head-success"><i class="fas fa-check-circle me-1"></i> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (<span id="countSuccess">0</span>)</div>
                    <div class="status-column" id="colSuccess"></div>
                </div>
                <div class="col-md-4">
                    <div class="status-header bg-head-warning"><i class="fas fa-truck me-1"></i> ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á (<span id="countPending">0</span>)</div>
                    <div class="status-column" id="colPending"></div>
                </div>
                <div class="col-md-4">
                    <div class="status-header bg-head-danger"><i class="fas fa-times-circle me-1"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (<span id="countFailed">0</span>)</div>
                    <div class="status-column" id="colFailed"></div>
                </div>
            </div>
            <div class="text-center mt-5 mb-5">
                <button id="loadMoreBtn" class="load-more-btn shadow-sm" style="display: none;" onclick="loadMore()">
                    <i class="fas fa-chevron-down me-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
                <div id="displayCountText" class="text-muted mt-2 small"></div>
            </div>
        </div>
    </div>

    <script>
        // üü¢ URL Apps Script (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySB82ezMwS67wsHDOPvINwK1BFoaVxYz1moaYFUv1TOMC9yflcu-edYCZS79AOjNdS/exec";
        
        const COL_MAP = {
            PO: "PO", WAREHOUSE: "‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏•‡∏±‡∏á", STATUS: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", 
            DATE: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á", STATION: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á"
        };

        let currentUserRole = ""; 
        let currentUserWarehouse = ""; 
        let globalHeaders = [];

        async function handleLogin(e) {
            e.preventDefault();
            const inputId = document.getElementById('loginId').value;
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('loginMsg');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...'; msg.innerText = "";

            try {
                const response = await fetch(`${SCRIPT_URL}?action=login&id=${inputId}`);
                const result = await response.json();
                if (result.status === 'success') {
                    currentUserRole = result.role;
                    currentUserWarehouse = String(result.warehouse || "").trim(); 
                    document.getElementById('userRoleDisplay').innerText = currentUserRole.toUpperCase();
                    if (currentUserWarehouse !== "") {
                        document.getElementById('userWarehouseBadge').style.display = 'inline-block';
                        document.getElementById('userWarehouseDisplay').innerText = currentUserWarehouse;
                    }
                    if (currentUserRole.toLowerCase() === 'admin') {
                        document.getElementById('headerUploadBtn').style.display = 'inline-block';
                    }
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    fetchData(); 
                } else {
                    msg.innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; btn.disabled = false; btn.innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå";
                }
            } catch (error) {
                msg.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message; btn.disabled = false; btn.innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå";
            }
        }

        function logout() { location.reload(); }

        function exportToExcel() {
            if (!currentDisplayData || currentDisplayData.length === 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export"); return; }
            const ws_data = [globalHeaders, ...currentDisplayData];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PO_Data");
            XLSX.writeFile(wb, "PO_Data_Export.xlsx");
        }

        function processUpload(targetSheetName, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå "${file.name}" ‡∏•‡∏á‡∏ä‡∏µ‡∏ó [${targetSheetName}] ?`)) { inputElement.value = ""; return; }
            
            const modalEl = document.getElementById('uploadModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if(modal) modal.hide();

            document.getElementById('uploadLoader').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (!jsonData || jsonData.length === 0) {
                        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå"); document.getElementById('uploadLoader').style.display = 'none'; return;
                    }
                    sendToBackend(targetSheetName, jsonData);
                } catch (err) {
                    document.getElementById('uploadLoader').style.display = 'none'; alert("Error: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            inputElement.value = ""; 
        }

        function sendToBackend(sheetName, jsonData) {
            fetch(SCRIPT_URL, {
                method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ sheetName: sheetName, data: jsonData })
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('uploadLoader').style.display = 'none';
                if (result.status === 'success') {
                    alert(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${result.message})`); fetchData(); 
                } else { alert("‚ùå Server Error: " + result.message); }
            })
            .catch(error => {
                document.getElementById('uploadLoader').style.display = 'none'; alert("‚ùå Upload Failed: " + error.message);
            });
        }

        let masterData = []; let activeSourceData = []; let activeSearchResults = []; let currentDisplayData = []; 
        let colIndexes = {}; let selectedSources = ['CHV', 'MRC', 'EX-Godown']; let selectedWarehouse = 'ALL'; 
        let renderLimit = 50; const LOAD_STEP = 50;

        async function fetchData() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getData`);
                // üü¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ JSON (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Object {data:[], lastUpdate:""})
                const result = await response.json(); 
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                let rawData = [];
                if (Array.isArray(result)) {
                    rawData = result; // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤
                } else if (result.data) {
                    rawData = result.data;
                    // üü¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                    if(result.lastUpdate) {
                        document.getElementById('lastUpdateDisplay').innerText = result.lastUpdate;
                    }
                }

                if (rawData && rawData.length > 0) {
                    const headers = rawData[0]; globalHeaders = headers; 
                    colIndexes = {
                        PO: headers.indexOf(COL_MAP.PO), WAREHOUSE: headers.indexOf(COL_MAP.WAREHOUSE),
                        STATUS: headers.indexOf(COL_MAP.STATUS), DATE: headers.indexOf(COL_MAP.DATE),
                        STATION: headers.indexOf(COL_MAP.STATION)
                    };
                    masterData = rawData.slice(1); 
                    updateDataBySource();
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('resultSection').style.display = 'block';
                }
            } catch (error) { document.getElementById('loader').innerHTML = `<span class="text-danger">Error: ${error.message}</span>`; }
        }

        window.toggleSource = function(sourceName, btn) {
            btn.classList.toggle('active');
            if (selectedSources.includes(sourceName)) { selectedSources = selectedSources.filter(s => s !== sourceName); } else { selectedSources.push(sourceName); }
            updateDataBySource();
        }

        function updateDataBySource() {
            activeSourceData = masterData.filter(row => selectedSources.includes(row[0]));
            const keyword = document.getElementById('searchInput').value.trim();
            if (keyword !== "") { performSearch(); } else {
                activeSearchResults = activeSourceData;
                if (currentUserWarehouse !== "") selectedWarehouse = currentUserWarehouse; else selectedWarehouse = 'ALL';
                createWarehouseButtons(activeSearchResults); renderFinalView();
            }
        }

        function createWarehouseButtons(dataSet) {
            const counts = {}; const idx = colIndexes.WAREHOUSE; if(idx === -1) return;
            dataSet.forEach(row => { let key = row[idx]; if (key === "" || key === null) return; counts[key] = (counts[key] || 0) + 1; });
            const keys = Object.keys(counts).sort();
            let html = `<button class="warehouse-btn ${selectedWarehouse === 'ALL' ? 'active' : ''}" onclick="clickWarehouse('ALL', this)">All <span class="count-badge">${dataSet.length}</span></button>`;
            keys.forEach(key => {
                const isActive = (String(key) === String(selectedWarehouse)) ? 'active' : '';
                html += `<button class="warehouse-btn ${isActive}" onclick="clickWarehouse('${key}', this)">${key} <span class="count-badge">${counts[key]}</span></button>`;
            });
            document.getElementById('filterButtonContainer').innerHTML = html;
        }

        window.clickWarehouse = function(key, btn) {
            document.querySelectorAll('.warehouse-btn').forEach(b => b.classList.remove('active'));
            if(btn) { btn.classList.add('active'); } else {
                const allBtns = document.querySelectorAll('.warehouse-btn');
                allBtns.forEach(b => { if(key === 'ALL' && b.innerText.includes('All')) b.classList.add('active'); else if(b.innerText.includes(key) && !b.innerText.includes('All')) b.classList.add('active'); });
            }
            selectedWarehouse = key; renderFinalView();
        }

        function renderFinalView() {
            const idx = colIndexes.WAREHOUSE;
            if (selectedWarehouse === 'ALL') { currentDisplayData = activeSearchResults; } 
            else { currentDisplayData = activeSearchResults.filter(row => String(row[idx]) === String(selectedWarehouse)); }
            renderLimit = LOAD_STEP; renderCards();
        }

        window.performSearch = function() {
            const rawKeyword = document.getElementById('searchInput').value.toLowerCase().trim();
            if (rawKeyword !== "") {
                const searchTerms = rawKeyword.split(/[\s,]+/).filter(term => term.length > 0);
                const idxPO = colIndexes.PO;
                activeSearchResults = activeSourceData.filter(row => { const poValue = String(row[idxPO] || "").toLowerCase(); return searchTerms.some(term => poValue.includes(term)); });
            } else { activeSearchResults = activeSourceData; }
            createWarehouseButtons(activeSearchResults);
            if (currentUserWarehouse !== "") selectedWarehouse = currentUserWarehouse; else selectedWarehouse = 'ALL'; 
            renderFinalView();
        }

        window.loadMore = function() { renderLimit += LOAD_STEP; renderCards(); }

        function renderCards() {
            const noDataMsg = document.getElementById('noDataMessage');
            const cardContainer = document.getElementById('cardContainer');
            if (currentDisplayData.length === 0) {
                cardContainer.style.display = 'none'; document.getElementById('loadMoreBtn').style.display = 'none';
                noDataMsg.style.display = 'block';
                const keyword = document.getElementById('searchInput').value;
                noDataMsg.innerHTML = keyword ? `<div class="no-data-alert"><i class="fas fa-search fa-2x mb-3 text-muted"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>` : `<div class="no-data-alert"><i class="fas fa-box-open fa-2x mb-3 text-muted"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡∏µ‡πâ</div>`;
                return;
            } else { noDataMsg.style.display = 'none'; cardContainer.style.display = 'flex'; }

            let htmlSuccess = "", htmlPending = "", htmlFailed = "";
            let realCountS = 0, realCountP = 0, realCountF = 0;
            let showCountS = 0, showCountP = 0, showCountF = 0;
            const vendorStyles = { 'CHV': { name: 'Chevron', bg: '#0d6efd' }, 'MRC': { name: 'Miracle', bg: '#198754' }, 'EX-Godown': { name: 'PSP', bg: '#ffc107', text: 'black' } };

            currentDisplayData.forEach(row => {
                const po = row[colIndexes.PO] || "-"; const wh = row[colIndexes.WAREHOUSE] || "-";
                let status = (row[0] === 'EX-Godown') ? String(row[3] || "").trim() : String(row[colIndexes.STATUS] || "").trim();
                
                let bucket = "PENDING"; let cardClass = "card-border-warning"; let statusBadge = `<span class="status-badge bg-warning text-dark">${status || '‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á'}</span>`;
                if (status === "Pass" || status === "Completed" || status === "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" || status.includes("‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à")) { bucket = "SUCCESS"; cardClass = "card-border-success"; statusBadge = `<span class="status-badge bg-success">${status || '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</span>`; } 
                else if (status === "Fail" || status === "Rejected" || status === "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" || status === "Invalid Date") { bucket = "FAILED"; cardClass = "card-border-danger"; statusBadge = `<span class="status-badge bg-danger">${status || '‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</span>`; }

                if (bucket === "SUCCESS") realCountS++; else if (bucket === "FAILED") realCountF++; else realCountP++;

                let shouldRender = false;
                if (bucket === "SUCCESS" && showCountS < renderLimit) { shouldRender = true; showCountS++; }
                else if (bucket === "PENDING" && showCountP < renderLimit) { shouldRender = true; showCountP++; }
                else if (bucket === "FAILED" && showCountF < renderLimit) { shouldRender = true; showCountF++; }

                if (shouldRender) {
                    let dateVal = row[colIndexes.DATE];
                    if(dateVal && String(dateVal).includes('T')) { try { dateVal = new Date(dateVal).toLocaleDateString('th-TH'); } catch(e){} } else if (!dateVal) { dateVal = "-"; }
                    const station = row[colIndexes.STATION] || "-";
                    const vendorCode = row[0];
                    const vendorInfo = vendorStyles[vendorCode] || { name: vendorCode, bg: '#6c757d' };
                    const cardHTML = `<div class="po-card ${cardClass}"><div class="po-header"><span>PO: ${po}</span><span class="vendor-tag" style="background:${vendorInfo.bg}; color:${vendorInfo.text||'white'}">${vendorInfo.name}</span></div><div class="po-body"><div class="info-row"><div class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á:</div><div class="info-value text-truncate">${wh}</div></div><div class="info-row"><div class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ:</div><div class="info-value text-truncate">${station}</div></div><div class="info-row"><div class="info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á:</div><div class="info-value">${dateVal}</div></div><div class="mt-2 d-flex justify-content-between align-items-center"><small class="text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</small> ${statusBadge}</div></div></div>`;
                    if (bucket === "SUCCESS") htmlSuccess += cardHTML; else if (bucket === "FAILED") htmlFailed += cardHTML; else htmlPending += cardHTML;
                }
            });

            document.getElementById('colSuccess').innerHTML = htmlSuccess; document.getElementById('colPending').innerHTML = htmlPending; document.getElementById('colFailed').innerHTML = htmlFailed;
            document.getElementById('countSuccess').innerText = realCountS.toLocaleString(); document.getElementById('countPending').innerText = realCountP.toLocaleString(); document.getElementById('countFailed').innerText = realCountF.toLocaleString();
            
            const totalShown = showCountS + showCountP + showCountF; const totalAll = realCountS + realCountP + realCountF;
            const btn = document.getElementById('loadMoreBtn'); const txt = document.getElementById('displayCountText');
            if (totalShown < totalAll) { btn.style.display = "inline-block"; txt.innerText = `‡πÅ‡∏™‡∏î‡∏á ${totalShown.toLocaleString()} ‡∏à‡∏≤‡∏Å ${totalAll.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; } else { btn.style.display = "none"; txt.innerText = `‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalAll.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; }
        }
    </script>
</body>
</html>
